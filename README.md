<p align="center">
  <img height="340" src="https://xuejmnet.github.io/sharding-core-doc/logo.svg">
</p>

# English | [‰∏≠Êñá](https://github.com/dotnetcore/sharding-core/blob/main/README-zh.md)

# ShardingCore
high performance lightweight solution for efcore sharding table and sharding database support read-write-separation.
- zero dependency
- zero learning cost
- zero incursion

---
- [Gitee](https://gitee.com/xuejm/sharding-core) ÂõΩÂÜÖÈïúÂÉè

- [ÊçêËµ†](#ÊçêËµ†)

## Community Partners and Sponsors

<a href="https://www.jetbrains.com/?from=.NETCoreCommunity(NCC)" target="_blank">
<img src="./imgs/jetbrains.png" title="JetBrains" width=130 />
</a>

## üìö Documentation

[‰∏≠ÊñáÊñáÊ°£Github](https://xuejmnet.github.io/sharding-core-doc/) | [English Document Github](https://xuejmnet.github.io/sharding-core-doc/en/)


[‰∏≠ÊñáÊñáÊ°£Gitee](https://xuejm.gitee.io/sharding-core-doc/) | [English Document Gitee](https://xuejm.gitee.io/sharding-core-doc/en/)

## How Choose Version
- shardingcore lastversion.efcoreversion.x.x

- first version is shardingcore version
- second version is efcore version 
- other version use last version
-
- efcore9 use shardingcore7.9.x.x
- efcore8 use shardingcore7.8.x.x

- efcore7 use shardingcore7.7.x.x

- efcore6 use shardingcore7.6.x.x

- efcore5 use shardingcore7.5.x.x

- efcore3 use shardingcore7.3.x.x

- efcore2 use shardingcore7.2.x.x

## Abp.VNext„ÄÅWTM„ÄÅFURION
- [ShardingFrameWork](https://github.com/xuejmnet/ShardingWithFramework) demos

## Dependency

### Before ShardingCore 6.7.0.0

Release  | EF Core | .NET  | .NET (Core) 
--- | --- | --- | --- 
[6.x.x.x](https://www.nuget.org/packages/ShardingCore) |  6.0.0 | net 6.0 | 6.0+ 
[5.x.x.x](https://www.nuget.org/packages/ShardingCore) |  5.0.10 | Standard 2.1 | 5.0+ 
[3.x.x.x](https://www.nuget.org/packages/ShardingCore) | 3.1.18 | Standard 2.0 | 2.0+ 
[2.x.x.x](https://www.nuget.org/packages/ShardingCore) | 2.2.6 | Standard 2.0 | 2.0+ 
### After ShardingCore 6.7.0.0

Use Condition Compile With NetFramework not

Release  | EF Core | .NET (Core) 
--- | --- |  --- 
[6.7.0.0+](https://www.nuget.org/packages/ShardingCore)| 6.x     | net6                          
[6.7.0.0+](https://www.nuget.org/packages/ShardingCore)| 5.x     | net5 or netstandard2.1       
[6.7.0.0+](https://www.nuget.org/packages/ShardingCore)| 3.x     | netcoreapp3 or netstandard2.0 
[6.7.0.0+](https://www.nuget.org/packages/ShardingCore)| 2.x     | netcoreapp2                  


## Quick start
5 steps implement sharding by month and support auto create table by month
### Step 1: Install the package
Choose data base driver for efcore
```shell
# basic package[README-zh.md](README-zh.md)
PM> Install-Package ShardingCore
# sqlserver driver
PM> Install-Package Microsoft.EntityFrameworkCore.SqlServer
# mysql driver
#PM> Install-Package Pomelo.EntityFrameworkCore.MySql
# use other database driver,if efcore support
```

### Step 2: Query entity
Query entity order
```csharp

    /// <summary>
    /// order table
    /// </summary>
    public class Order
    {
        /// <summary>
        /// order Id
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// payer id
        /// </summary>
        public string Payer { get; set; }
        /// <summary>
        /// pay money cent
        /// </summary>
        public long Money { get; set; }
        /// <summary>
        /// area
        /// </summary>
        public string Area { get; set; }
        /// <summary>
        /// order status
        /// </summary>
        public OrderStatusEnum OrderStatus { get; set; }
        /// <summary>
        /// CreationTime
        /// </summary>
        public DateTime CreationTime { get; set; }
    }
    public enum OrderStatusEnum
    {
        NoPay=1,
        Paying=2,
        Payed=3,
        PayFail=4
    }
```
### Step 3: Create DbContext
Create `MyDbContext` extends `AbstractShardingDbContext`,
then this dbcontext support sharding database,if u want support 
sharding table(spilt table eg. order_202101,order_202102,order_202103......),u need implements `IShardingTableDbContext`
```csharp

    public class MyDbContext:AbstractShardingDbContext,IShardingTableDbContext
    {
        public MyDbContext(DbContextOptions<MyDbContext> options) : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.Entity<Order>(entity =>
            {
                entity.HasKey(o => o.Id);
                entity.Property(o => o.Id).IsRequired().IsUnicode(false).HasMaxLength(50);
                entity.Property(o=>o.Payer).IsRequired().IsUnicode(false).HasMaxLength(50);
                entity.Property(o => o.Area).IsRequired().IsUnicode(false).HasMaxLength(50);
                entity.Property(o => o.OrderStatus).HasConversion<int>();
                //really table name is Order_202101,Order_202102,Order_202103.....
                entity.ToTable(nameof(Order));
            });
        }
        /// <summary>
        /// empty implment if use sharding table
        /// </summary>
        public IRouteTail RouteTail { get; set; }
    }
```

### Step 4:Create route that data(Order) query mapping table name

```csharp
//Route constructor support dependency injection,that's life time scope is `Singleton`

    public class OrderVirtualTableRoute:AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<Order>
    {
        //private readonly IServiceProvider _serviceProvider;

        //public OrderVirtualTableRoute(IServiceProvider serviceProvider)
        //{
            //_serviceProvider = serviceProvider;
        //}
        /// <summary>
        /// fixed value don't use DateTime.Now because if  if application restart this value where change
        /// </summary>
        /// <returns></returns>
        public override DateTime GetBeginTime()
        {
            return new DateTime(2021, 1, 1);
        }
        /// <summary>
        /// configure sharding property
        /// </summary>
        /// <param name="builder"></param>

        public override void Configure(EntityMetadataTableBuilder<Order> builder)
        {
            builder.ShardingProperty(o => o.CreationTime);
        }
        /// <summary>
        /// enable auto create table job
        /// </summary>
        /// <returns></returns>

        public override bool AutoCreateTableByTime()
        {
            return true;
        }
    }
```

### Step 5: Start up Configure
u need modify `AddDefaultDataSource` method second param(connection string),don't modify `UseShardingQuery`„ÄÅ`UseShardingTransaction` delegate params
```csharp

        public void ConfigureServices(IServiceCollection services)
        {

            //sharding config
            services.AddShardingDbContext<MyDbContext>()
                .UseRouteConfig(op =>
                {
                    op.AddShardingTableRoute<OrderVirtualTableRoute>();
                }).UseConfig(op =>
                {
                    op.UseShardingQuery((connStr, builder) =>
                    {
                        //connStr is delegate input param
                        builder.UseSqlServer(connStr);
                    });
                    op.UseShardingTransaction((connection, builder) =>
                    {
                        //connection is delegate input param
                        builder.UseSqlServer(connection);
                    });
                    //use your data base connection string
                    op.AddDefaultDataSource(Guid.NewGuid().ToString("n"),
                        "Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;");
                }).AddShardingCore();
        }

        public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
        {
            if (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }
            //not required, enable check table missing and auto create,ÈùûÂøÖÈ°ª  ÂêØÂä®Ê£ÄÊü•Áº∫Â∞ëÁöÑË°®Âπ∂‰∏îÂàõÂª∫
            app.ApplicationServices.UseAutoTryCompensateTable();
            // other configure....
        }
```
then efcore support sharding tableÔºålike sharding-jdbc in java,u can happy coding for efcore

```csharp
[Route("api/[controller]")]
public class ValuesController : Controller
{
        private readonly MyDbContext _myDbContext;

        public ValuesController(MyDbContext myDbContext)
        {
            _myDbContext = myDbContext;
        }

        [HttpGet]
        public async Task<IActionResult> Get()
        {
            
            //_myDbContext.Add(order);
            //_myDbContext.Udpate(order);
            //_myDbContext.Remove(order);
            //_myDbContext.SaveChanges();
            var order = await _myDbContext.Set<Order>().FirstOrDefaultAsync(o => o.Id == "2");
            return OK(order)
        }
}
```


## Performance

Test 
 - on expression compile cache
 - ShardingCore x.3.1.63+ version
 - efcore 6.0 version
 - order id is string, sharding mod(hashcode%5)
 - N mean execute count

[Benchmark Demo](https://github.com/xuejmnet/sharding-core/blob/main/benchmarks/ShardingCoreBenchmark/EFCoreCrud.cs)

### ÊÄßËÉΩÊçüËÄó sql server 2012,data rows 7734363 =773w

// * Summary *

BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)
AMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores
.NET SDK=6.0.100
  [Host]     : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT
  DefaultJob : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT


|                             Method |  N |     Mean |     Error |    StdDev |
|----------------------------------- |--- |---------:|----------:|----------:|
| NoShardingIndexFirstOrDefaultAsync | 10 | 1.512 ms | 0.0071 ms | 0.0063 ms |
|   ShardingIndexFirstOrDefaultAsync | 10 | 1.567 ms | 0.0127 ms | 0.0113 ms |

ÈíàÂØπÊú™ÂàÜÁâáÊï∞ÊçÆÁöÑÊü•ËØ¢ÊÄßËÉΩ,ÂèØ‰ª•ÁúãÂá∫10Ê¨°Êü•ËØ¢Â∑ÆË∑ù‰∏∫0.05ms,ÂçïÊ¨°Êü•ËØ¢ÊçüËÄóÁ∫¶‰∏∫5ÂæÆÂ¶ô=0.005ÊØ´Áßí,ÊçüËÄóÂç†ÊØî‰∏∫3%,

ÁªìËÆ∫Ôºöefcore ÂéüÁîüÊü•ËØ¢Âíåsharding-coreÁöÑÊü•ËØ¢Âú®ÈíàÂØπÊú™ÂàÜÁâáÂØπË±°Êü•ËØ¢‰∏äÊÄßËÉΩÂèØËææÂéüÂÖàÁöÑ97%ÂÖ∑ÊúâÊûÅÈ´òÁöÑÊÄßËÉΩ

### ÊÄßËÉΩÊµãËØï


#### sql server 2012,data rows 7734363 =773w

// * Summary *

BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)
AMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores
.NET SDK=6.0.101
[Host]     : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT
DefaultJob : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT


|                               Method |  N |       Mean |      Error |     StdDev |
|------------------------------------- |--- |-----------:|-----------:|-----------:|
|   NoShardingIndexFirstOrDefaultAsync | 10 |   1.678 ms |  0.0323 ms |  0.0359 ms |
|     ShardingIndexFirstOrDefaultAsync | 10 |   2.005 ms |  0.0161 ms |  0.0143 ms |
| NoShardingNoIndexFirstOrDefaultAsync | 10 | 495.933 ms |  9.4911 ms | 10.5494 ms |
|   ShardingNoIndexFirstOrDefaultAsync | 10 | 596.112 ms | 11.8907 ms | 13.2165 ms |
|          NoShardingNoIndexCountAsync | 10 | 477.537 ms |  1.4817 ms |  1.2373 ms |
|            ShardingNoIndexCountAsync | 10 | 594.833 ms |  7.4057 ms |  5.7819 ms |
|     NoShardingNoIndexLikeToListAsync | 10 | 665.277 ms |  1.3382 ms |  1.1174 ms |
|       ShardingNoIndexLikeToListAsync | 10 | 840.865 ms | 16.1917 ms | 17.3249 ms |
|         NoShardingNoIndexToListAsync | 10 | 480.368 ms |  1.3688 ms |  1.2134 ms |
|           ShardingNoIndexToListAsync | 10 | 604.850 ms |  8.6204 ms |  8.0635 ms |

#### mysql 5.7,data rows 7553790=755w innerdb_buffer_size=3G



// * Summary *

BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)
AMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores
.NET SDK=6.0.101
[Host]     : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT
DefaultJob : .NET 6.0.1 (6.0.121.56705), X64 RyuJIT


|                               Method |  N |          Mean |       Error |      StdDev |
|------------------------------------- |--- |--------------:|------------:|------------:|
|   NoShardingIndexFirstOrDefaultAsync | 10 |      5.646 ms |   0.0164 ms |   0.0145 ms |
|     ShardingIndexFirstOrDefaultAsync | 10 |      5.679 ms |   0.0359 ms |   0.0319 ms |
| NoShardingNoIndexFirstOrDefaultAsync | 10 |  5,212.736 ms | 230.0841 ms | 678.4080 ms |
|   ShardingNoIndexFirstOrDefaultAsync | 10 |  2,013.107 ms |  10.4256 ms |   9.2420 ms |
|          NoShardingNoIndexCountAsync | 10 |  9,483.988 ms |  42.0931 ms |  39.3739 ms |
|            ShardingNoIndexCountAsync | 10 |  2,029.698 ms |  12.4008 ms |  10.9929 ms |
|     NoShardingNoIndexLikeToListAsync | 10 | 10,569.283 ms |  20.9163 ms |  16.3301 ms |
|       ShardingNoIndexLikeToListAsync | 10 |  2,208.804 ms |  11.0483 ms |  10.3346 ms |
|         NoShardingNoIndexToListAsync | 10 |  9,485.263 ms |  21.2558 ms |  17.7496 ms |
|           ShardingNoIndexToListAsync | 10 |  2,012.086 ms |  39.2986 ms |  45.2563 ms |

ÂÖ∑‰ΩìÂèØ‰ª•ÈÄöËøáfirstÂâç‰∏§Ê¨°ÁªìÊûúÊù•ËÆ°ÁÆóÂæóÂá∫ÁªìËÆ∫ÂçïÊ¨°Êü•ËØ¢ÁöÑÁöÑÊçüËÄó‰∏∫0.04ÊØ´Áßí‰∏ä‰∏ãÔºå sqlserverÁöÑÂêÑÈ°πÊï∞ÊçÆÂú®ÂàÜË°®ÂíåÊú™ÂàÜË°®ÁöÑÊÉÖÂÜµ‰∏ãÈÉΩÂá†‰πéÂ∑Æ‰∏çÂ§öÂèØ‰ª•ÂæóÂá∫Âú®770wÊï∞ÊçÆÈõÜÊÉÖÂÜµ‰∏ãÊï∞ÊçÆÂ∫ìËøòÂπ∂Êú™ÊòØÊï∞ÊçÆÁì∂È¢àÁöÑÂÖ≥ÈîÆÔºå‰ΩÜÊòØmysqlÂèØ‰ª•ÁúãÂà∞Âú®ÂàÜË°®ÂíåÊú™ÂàÜË°®ÁöÑÊÉÖÂÜµ‰∏ãÂ¶ÇÊûúÊ∂âÂèäÂà∞Ê≤°ÊúâÁ¥¢ÂºïÁöÑÂÖ®Ë°®Êâ´ÊèèÈÇ£‰πàÊÄßËÉΩÁöÑÂ∑ÆË∑ùÂ∞ÜÊòØÂàÜË°®ÂêéÁöÑË°®Êï∞ÁõÆ‰πãÂ§öÔºåÊµãËØï‰∏≠‰∏∫5-6ÂÄçÔºå‰πüÂ∞±ÊòØÂàÜË°®Êï∞ÁõÆ


- [‰ΩøÁî®‰ªãÁªç](#‰ΩøÁî®‰ªãÁªç)
    - [ÁÆÄ‰ªã](#ÁÆÄ‰ªã)
    - [Ê¶ÇÂøµ](#Ê¶ÇÂøµ)
    - [‰ºòÁÇπ](#‰ºòÁÇπ)
    - [Áº∫ÁÇπ](#Áº∫ÁÇπ)
    - [ÂÆâË£Ö](#ÂÆâË£Ö)
- [ÂºÄÂßã](#ÂºÄÂßã)
    - [ÂàÜË°®](#ÂàÜË°®)
    - [ÂàÜÂ∫ì](#ÂàÜÂ∫ì)
    - [ÈªòËÆ§Ë∑ØÁî±](#ÈªòËÆ§Ë∑ØÁî±)
    - [Api](#Api)
- [È´òÁ∫ßÈÖçÁΩÆ](#È´òÁ∫ßÈÖçÁΩÆ)
    - [code-first](#code-first)
    - [Ëá™Âä®ËøΩË∏™](#Ëá™Âä®ËøΩË∏™)
    - [ÊâãÂä®Ë∑ØÁî±](#ÊâãÂä®Ë∑ØÁî±)
    - [Ëá™Âä®Âª∫Ë°®](#Ëá™Âä®Âª∫Ë°®)
    - [‰∫ãÂä°](#‰∫ãÂä°)
    - [ÊâπÈáèÊìç‰Ωú](#ÊâπÈáèÊìç‰Ωú)
    - [ËØªÂÜôÂàÜÁ¶ª](#ËØªÂÜôÂàÜÁ¶ª)
    - [È´òÊÄßËÉΩÂàÜÈ°µ](#È´òÊÄßËÉΩÂàÜÈ°µ)
    - [Ë°®ËææÂºèÁºìÂ≠ò](#Ë°®ËææÂºèÁºìÂ≠ò)
- [Ê≥®ÊÑè‰∫ãÈ°π](#Ê≥®ÊÑè‰∫ãÈ°π)
- [ËÆ°Âàí(Future)](#ËÆ°Âàí)
- [ÊúÄÂêé](#ÊúÄÂêé)

# ‰ΩøÁî®‰ªãÁªç

‰ª•‰∏ãÊâÄÊúâ‰æãÂ≠êÈÉΩ‰ª•Sql Server‰∏∫‰æã Â±ïÁ§∫ÁöÑ‰ª£Á†ÅÂùáÊòØÂàÜË°®‰∏∫‰æã,Â¶ÇÊûúÈúÄË¶ÅÂàÜÂ∫ìÂèØ‰ª•ÂèÇËÄÉ[Sample.SqlServerShardingDataSource](https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource) ÂÖ∂‰ªñÊï∞ÊçÆÂ∫ì‰∫¶ÊòØÂ¶ÇÊ≠§


## ÁÆÄ‰ªã

ÁÆÄÂçï‰ªãÁªç‰∏ãËøô‰∏™Â∫ì,Ëøô‰∏™Â∫ìÁöÑÊâÄÊúâÁâàÊú¨ÈÉΩÊòØÁî±ÂØπÂ∫îÁöÑefcoreÁâàÊú¨Âè∑‰∏∫‰∏ªÁöÑÁâàÊú¨ÔºåÁ¨¨‰∫å‰∏™ÁâàÊú¨Âè∑Â¶ÇÊûúÊòØ2ÁöÑË°®Á§∫‰ªÖÊîØÊåÅÂàÜÂ∫ì,Â¶ÇÊûúÊòØ3+ÁöÑË°®Á§∫ÊîØÊåÅÂàÜÂ∫ìÂàÜË°®ÔºåËøô‰∏™Â∫ìÁõÆÂâçÂàÜÊàê‰∏§‰∏™‰∏ªË¶ÅÁâàÊú¨‰∏Ä‰∏™ÊòØmainÂàÜÊîØ‰∏Ä‰∏™ÊòØshardingTableOnlyÂàÜÊîØ,ËØ•Â∫ìÊîØÊåÅÂàÜÂ∫ìÂÆåÂÖ®Ëá™ÂÆö‰πâË∑ØÁî±ÈÄÇÁî®‰∫é95%ÁöÑ‰∏öÂä°ÈúÄÊ±Ç,ÂàÜË°®ÊîØÊåÅx+y+z,xË°®Á§∫Âõ∫ÂÆöÁöÑË°®Âêç,yË°®Á§∫Âõ∫ÂÆöÁöÑË°®ÂêçÂíåË°®ÂêéÁºÄ‰πãÈó¥ÁöÑËÅîÁ≥ª(ÂèØ‰ª•‰∏∫Á©∫),zË°®Á§∫Ë°®ÂêéÁºÄ,ÂèØ‰ª•ÊåâÁÖß‰Ω†Ëá™Â∑±ÁöÑ‰ªªÊÑè‰∏öÂä°ÈÄªËæëËøõË°åÂàáÂàÜ,
Â¶Ç:user_0,user_1ÊàñËÄÖuser202101,user202102...ÂΩìÁÑ∂ËØ•Â∫ìÂêåÊ†∑ÈÄÇÁî®‰∫éÂ§öÁßüÊà∑Ê®°Âºè‰∏ãÁöÑÈöîÁ¶ª
ÊîØÊåÅÂ§öÁßçÊü•ËØ¢ÂåÖÊã¨```join,group by,max,count,min,avg,sum``` ...Á≠â‰∏ÄÁ≥ªÂàóÊü•ËØ¢,‰πãÂêéÂèØËÉΩ‰ºöÊ∑ªÂä†Êõ¥Â§öÊîØÊåÅ,ÁõÆÂâçËØ•Â∫ìÁöÑ‰ΩøÁî®ÈùûÂ∏∏ÁÆÄÂçï,Âü∫Êú¨‰∏äÂ∞±ÊòØÈíàÂØπIQueryableÁöÑÊâ©Â±ïÔºå‰∏∫‰∫Ü‰øùËØÅ
ËØ•Â∫ìÁöÑÂπ≤ÂáÄÈõ∂‰æùËµñ,Â¶ÇÊûúÈúÄË¶ÅÂÆûÁé∞Ëá™Âä®Âª∫Ë°®ÈúÄË¶ÅËá™Â∑±ÈÖçÂêàÂÆöÊó∂‰ªªÂä°,Âç≥ÂèØÂÆåÊàê24Â∞èÊó∂Êó†‰∫∫ÁúãÁÆ°Ëá™Âä®ÁÆ°ÁêÜ„ÄÇËØ•Â∫ìÊèê‰æõ‰∫Ü [IShardingTableCreator](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/TableCreator/IShardingTableCreator.cs)
‰Ωú‰∏∫Âª∫Ë°®ÁöÑ‰æùËµñ,Â¶ÇÊûúÈúÄË¶ÅÂèØ‰ª•ÂèÇËÄÉ [ÊåâÂ§©Ëá™Âä®Âª∫Ë°®](https://github.com/xuejmnet/sharding-core/tree/main/samples/Samples.AutoByDate.SqlServer) ËØ•demoÊòØÈíàÂØπÂàÜÂ∫ìÁöÑÂä®ÊÄÅÊ∑ªÂä†

## Ê¶ÇÂøµ

Êú¨Â∫ìÁöÑÂá†‰∏™ÁÆÄÂçïÁöÑÊ†∏ÂøÉÊ¶ÇÂøµ:

### ÂàÜÂ∫ìÊ¶ÇÂøµ
- [DataSourceName]
  Êï∞ÊçÆÊ∫êÂêçÁß∞Áî®Êù•Â∞ÜÂØπË±°Ë∑ØÁî±Âà∞ÂÖ∑‰ΩìÁöÑÊï∞ÊçÆÊ∫ê
- [IVirtualDataSource]
  ËôöÊãüÊï∞ÊçÆÊ∫ê [IVirtualDataSource](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualDatabase/VirtualDataSources/IVirtualDataSource.cs)
- [IVirtualDataSourceRoute]
  ÂàÜÂ∫ìË∑ØÁî±  [IVirtualDataSourceRoute](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualRoutes/DataSourceRoutes/IVirtualDataSourceRoute.cs)
### ÂàÜË°®Ê¶ÇÂøµ
- [Tail]
  Â∞æÂ∑¥„ÄÅÂêéÁºÄÁâ©ÁêÜË°®ÁöÑÂêéÁºÄ
- [TailPrefix]
  Â∞æÂ∑¥ÂâçÁºÄËôöÊãüË°®ÂíåÁâ©ÁêÜË°®ÁöÑÂêéÁºÄ‰∏≠Èó¥ÁöÑÂ≠óÁ¨¶
- [Áâ©ÁêÜË°®]
  È°æÂêçÊÄù‰πâÂ∞±ÊòØÊï∞ÊçÆÂ∫ìÂØπÂ∫îÁöÑÂÆûÈôÖË°®‰ø°ÊÅØ,Ë°®Âêç(tablename+ tailprefix+ tail) [IPhysicTable](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/PhysicTables/IPhysicTable.cs)
- [ËôöÊãüË°®]
  ËôöÊãüË°®Â∞±ÊòØÁ≥ªÁªüÂ∞ÜÊâÄÊúâÁöÑÁâ©ÁêÜË°®Âú®Á≥ªÁªüÈáåÈù¢ËøõË°åÊäΩË±°ÁöÑ‰∏Ä‰∏™ÊÄªË°®ÂØπÂ∫îÂà∞Á®ãÂ∫èÂ∞±ÊòØ‰∏Ä‰∏™entity[IVirtualTable](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualDatabase/VirtualTables/IVirtualTable.cs)
- [ËôöÊãüË∑ØÁî±]
  ËôöÊãüË∑ØÁî±Â∞±ÊòØËÅîÁ≥ªËôöÊãüË°®ÂíåÁâ©ÁêÜË°®ÁöÑ‰∏≠Èó¥‰ªãË¥®,ËôöÊãüË°®Âú®Êï¥‰∏™Á®ãÂ∫è‰∏≠Âè™Êúâ‰∏Ä‰ªΩ,ÈÇ£‰πàÁ®ãÂ∫èÂ¶Ç‰ΩïÁü•ÈÅìË¶ÅÊü•ËØ¢Á≥ªÁªüÂì™‰∏ÄÂº†Ë°®Âë¢,ÊúÄÁÆÄÂçïÁöÑÊñπÂºèÂ∞±ÊòØÈÄöËøáËôöÊãüË°®ÂØπÂ∫îÁöÑË∑ØÁî±[IVirtualTableRoute](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualRoutes/TableRoutes/IVirtualTableRoute.cs)
  ,Áî±‰∫éÂü∫Êú¨‰∏äÊâÄÊúâÁöÑË∑ØÁî±ÈÉΩÊòØÂíå‰∏öÂä°ÈÄªËæëÁõ∏ÂÖ≥ÁöÑÊâÄ‰ª•ËôöÊãüË∑ØÁî±Áî±Áî®Êà∑Ëá™Â∑±ÂÆûÁé∞,ËØ•Ê°ÜÊû∂Êèê‰æõ‰∏Ä‰∏™È´òÁ∫ßÊäΩË±°

## ‰ºòÁÇπ

- [ÊîØÊåÅËá™ÂÆö‰πâÂàÜÂ∫ì]
- [ÊîØÊåÅËØªÂÜôÂàÜÁ¶ª]
- [ÊîØÊåÅÈ´òÊÄßËÉΩÂàÜÈ°µ]
- [ÊîØÊåÅÊâãÂä®Ë∑ØÁî±]
- [ÊîØÊåÅÊâπÈáèÊìç‰Ωú]
- [ÊîØÊåÅËá™ÂÆö‰πâÂàÜË°®ËßÑÂàô]
- [ÊîØÊåÅ‰ªªÊÑèÁ±ªÂûãÂàÜË°®key]
- [ÂØπdbcontextÂ≠¶‰π†ÊàêÊú¨0]
- [ÊîØÊåÅÂàÜË°®‰∏ãÁöÑËøûË°®] ```join,group by,max,count,min,avg,sum```
- [ÊîØÊåÅÈíàÂØπÊâπÂ§ÑÁêÜÁöÑ‰ΩøÁî®] [EFCore.BulkExtensions](https://github.com/borisdj/EFCore.BulkExtensions) ...ÊîØÊåÅefcoreÁöÑÊâ©Â±ïÁîüÊÄÅ
- [Êèê‰æõÂ§öÁßçÈªòËÆ§ÂàÜË°®ËßÑÂàôË∑ØÁî±] ÊåâÊó∂Èó¥,ÊåâÂèñÊ®° ÂèØËá™ÂÆö‰πâ
- [ÈíàÂØπÂàÜÈ°µËøõË°å‰ºòÂåñ] Â§ßÈ°µÊï∞Ë∑≥ËΩ¨ÊîØÊåÅ‰ΩéÂÜÖÂ≠òÊµÅÂºèÂ§ÑÁêÜÔºåÈ´òÊÄßËÉΩÂàÜÈ°µ

## Áº∫ÁÇπ
- [Ê∂àËÄóËøûÊé•]Âá∫Áé∞ÂàÜË°®‰∏éÂàÜË°®ÂØπË±°ËøõË°åjoinÂ¶ÇÊûúÊù°‰ª∂Ê≤°Ê≥ïÁ¥¢ÂºïÂà∞ÂÖ∑‰ΩìË°®‰ºöÁîüÊàê```Á¨õÂç°Â∞îÁßØ```ÂØºËá¥ËøûÊé•Êï∞ÁàÜÁÇ∏,ÂêéÊúü‰ºöËøõË°åÈíàÂØπËØ•ÊÉÖÂÜµÁöÑÈÖçÁΩÆ

## ÂÆâË£Ö
```xml
<PackageReference Include="ShardingCore" Version="5.LastVersion" />
or
<PackageReference Include="ShardingCore" Version="3.LastVersion" />
or
<PackageReference Include="ShardingCore" Version="2.LastVersion" />
```

# ÂºÄÂßã
## ÂàÜË°®

Êàë‰ª¨‰ª•Áî®Êà∑ÂèñÊ®°Êù•ÂÅö‰æãÂ≠ê,ÈÖçÁΩÆentity Êé®Ëçê [fluent api](https://docs.microsoft.com/en-us/ef/core/modeling/) 

```c#
    public class SysUserMod
    {
        /// <summary>
        /// Áî®Êà∑IdÁî®‰∫éÂàÜË°®
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// Áî®Êà∑ÂêçÁß∞
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// Áî®Êà∑ÂßìÂêç
        /// </summary>
        public int Age { get; set; }
    }
    
```
ÂàõÂª∫virtual route
ÂÆûÁé∞ `AbstractShardingOperatorVirtualTableRoute<T, TKey>`
ÊäΩË±°,ÊàñËÄÖÂÆûÁé∞Á≥ªÁªüÈªòËÆ§ÁöÑËôöÊãüË∑ØÁî±
Ê°ÜÊû∂ÈªòËÆ§ÊúâÊèê‰æõÂá†‰∏™ÁÆÄÂçïÁöÑË∑ØÁî± [ÈªòËÆ§Ë∑ØÁî±](#ÈªòËÆ§Ë∑ØÁî±)

```c#

    public class SysUserModVirtualTableRoute : AbstractSimpleShardingModKeyStringVirtualRoute<SysUserMod>
    {
        //2 tail length:00,01,02......99
        //3 hashcode % 3: [0,1,2]
        public SysUserModVirtualTableRoute() : base(2,3)
        {
        }
        public override void Configure(EntityMetadataTableBuilder<SysUserMod> builder)
        {
            builder.ShardingProperty(o => o.Id);
        }
    }
```

Â¶ÇÊûú‰Ω†‰ΩøÁî®ÂàÜË°®ÂøÖÈ°ªÂàõÂª∫‰∏Ä‰∏™ÁªßÊâøËá™```IShardingTableDbContext```Êé•Âè£ÁöÑDbContext,
ÂøÖÈ°ªÂÆûÁé∞```IShardingDbContext```,ÈªòËÆ§Êèê‰æõ‰∫ÜAbstractShardingDbContext

```c#

  //DefaultTableDbContext is acutal execute dbcontext
    public class DefaultShardingDbContext:AbstractShardingDbContext,IShardingTableDbContext
    {
        public DefaultShardingDbContext(DbContextOptions<DefaultShardingDbContext> options) : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.ApplyConfiguration(new SysUserModMap());
        }
        public IRouteTail RouteTail { get; set; }

    }
```
`Startup.cs` ‰∏ãÁöÑ `ConfigureServices(IServiceCollection services)`

```c#

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllers();
            //if u want use no sharding operate
            //services.AddDbContext<DefaultTableDbContext>(o => o.UseSqlServer("Data Source=localhost;Initial Catalog=ShardingCoreDB;Integrated Security=True"));

    //add shardingdbcontext support life scope
                
        services.AddShardingDbContext<DefaultShardingDbContext>(
                   (conStr, builder) => builder.UseSqlServer(conStr)
                )
                .Begin(o =>
                {
                    o.CreateShardingTableOnStart = true;//create sharding table
                    o.EnsureCreatedWithOutShardingTable = true;//create data source with out sharding table
                })  .AddShardingTransaction((connection, builder) =>
                    builder.UseSqlServer(connection))
                .AddDefaultDataSource("ds0", "Data Source=localhost;Initial Catalog=ShardingCoreDB1;Integrated Security=True;")
                .AddShardingTableRoute(o =>
                {
                    o.AddShardingTableRoute<SysUserModVirtualTableRoute>();
                }).End();
```

`Startup.cs` ‰∏ãÁöÑ ` Configure(IApplicationBuilder app, IWebHostEnvironment env)` ‰Ω†‰πüÂèØ‰ª•Ëá™Ë°åÂ∞ÅË£Ö[app.UseShardingCore()](https://github.com/xuejmnet/sharding-core/blob/main/samples/Sample.SqlServer/DIExtension.cs)

```c#

            var shardingBootstrapper = app.ApplicationServices.GetRequiredService<IShardingBootstrapper>();
            shardingBootstrapper.Start();
```
Â¶Ç‰Ωï‰ΩøÁî®
```c#
    
        private readonly DefaultShardingDbContext _defaultShardingDbContext;

        public ctor(DefaultShardingDbContext defaultShardingDbContext)
        {
            _defaultShardingDbContext = defaultShardingDbContext;
        }

        public async Task Insert_1000()
        {
            if (!_defaultShardingDbContext.Set<SysUserMod>().Any())
                {
                    var ids = Enumerable.Range(1, 1000);
                    var userMods = new List<SysUserMod>();
                    foreach (var id in ids)
                    {
                        userMods.Add(new SysUserMod()
                        {
                            Id = id.ToString(),
                            Age = id,
                            Name = $"name_{id}",
                            AgeGroup = Math.Abs(id % 10)
                        });
                    }

                    _defaultShardingDbContext.AddRange(userMods);

                   await _defaultShardingDbContext.SaveChangesAsync();
                }
        }
        public async Task ToList_All()
        {
            
            var mods = await _defaultShardingDbContext.Set<SysUserMod>().ToListAsync();
            Assert.Equal(1000, mods.Count);

            var modOrders1 = await _defaultShardingDbContext.Set<SysUserMod>().OrderBy(o => o.Age).ToListAsync();
            int ascAge = 1;
            foreach (var sysUserMod in modOrders1)
            {
                Assert.Equal(ascAge, sysUserMod.Age);
                ascAge++;
            }

            var modOrders2 = await _defaultShardingDbContext.Set<SysUserMod>().OrderByDescending(o => o.Age).ToListAsync();
            int descAge = 1000;
            foreach (var sysUserMod in modOrders2)
            {
                Assert.Equal(descAge, sysUserMod.Age);
                descAge--;
            }
        }
```
## ÂàÜÂ∫ì

Êàë‰ª¨ËøòÊòØ‰ª•Áî®Êà∑ÂèñÊ®°Êù•ÂÅö‰æãÂ≠ê,ÈÖçÁΩÆentity Êé®Ëçê [fluent api](https://docs.microsoft.com/en-us/ef/core/modeling/) 
`IShardingDataSource`Êï∞ÊçÆÂ∫ìÂØπË±°ÂøÖÈ°ªÁªßÊâøËØ•Êé•Âè£
`ShardingDataSourceKey`ÂàÜÂ∫ìÂ≠óÊÆµÈúÄË¶Å‰ΩøÁî®ËØ•ÁâπÊÄß

```c#
    public class SysUserMod
    {
        /// <summary>
        /// Áî®Êà∑IdÁî®‰∫éÂàÜÂ∫ì
        /// </summary>
        public string Id { get; set; }
        /// <summary>
        /// Áî®Êà∑ÂêçÁß∞
        /// </summary>
        public string Name { get; set; }
        /// <summary>
        /// Áî®Êà∑ÂßìÂêç
        /// </summary>
        public int Age { get; set; }
    }
    
```
ÂàõÂª∫virtual route
ÂÆûÁé∞ `AbstractShardingOperatorVirtualTableRoute<T, TKey>`
ÊäΩË±°,ÊàñËÄÖÂÆûÁé∞Á≥ªÁªüÈªòËÆ§ÁöÑËôöÊãüË∑ØÁî±
Ê°ÜÊû∂ÈªòËÆ§ÊúâÊèê‰æõÂá†‰∏™ÁÆÄÂçïÁöÑË∑ØÁî± [ÈªòËÆ§Ë∑ØÁî±](#ÈªòËÆ§Ë∑ØÁî±)

```c#

    
    public class SysUserModVirtualDataSourceRoute:AbstractShardingOperatorVirtualDataSourceRoute<SysUserMod,string>
    {
        protected readonly int Mod=3;
        protected readonly int TailLength=1;
        protected readonly char PaddingChar='0';

        protected override string ConvertToShardingKey(object shardingKey)
        {
            return shardingKey.ToString();
        }

        public override string ShardingKeyToDataSourceName(object shardingKey)
        {
            var shardingKeyStr = ConvertToShardingKey(shardingKey);
            return "ds"+Math.Abs(ShardingCoreHelper.GetStringHashCode(shardingKeyStr) % Mod).ToString().PadLeft(TailLength, PaddingChar); ;
        }

        public override List<string> GetAllDataSourceNames()
        {
            return new List<string>()
            {
                "ds0",
                "ds1",
                "ds2"
            };
        }

        public override bool AddDataSourceName(string dataSourceName)
        {
            throw new NotImplementedException();
        }

        public override void Configure(EntityMetadataDataSourceBuilder<SysUserMod> builder)
        {
            builder.ShardingProperty(o => o.Name);
        }

        protected override Expression<Func<string, bool>> GetRouteToFilter(string shardingKey, ShardingOperatorEnum shardingOperator)
        {

            var t = ShardingKeyToDataSourceName(shardingKey);
            switch (shardingOperator)
            {
                case ShardingOperatorEnum.Equal: return tail => tail == t;
                default:
                {
                    return tail => true;
                }
            }
        }
    }
```

Â¶ÇÊûú‰Ω†‰ΩøÁî®ÂàÜÂ∫ìÂ∞±‰∏çÈúÄË¶Å```IShardingTableDbContext```Êé•Âè£ÁöÑDbContext
ÂàõÂª∫ÂàÜË°®DbContextÂøÖÈ°ªÁªßÊâøAbstractShardingDbContext


```c#

  //DefaultTableDbContext is acutal execute dbcontext
    public class DefaultShardingDbContext:AbstractShardingDbContext
    {
        public DefaultShardingDbContext(DbContextOptions<DefaultShardingDbContext> options) : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            modelBuilder.ApplyConfiguration(new SysUserModMap());
        }

    }
```
`Startup.cs` ‰∏ãÁöÑ `ConfigureServices(IServiceCollection services)`

```c#

        public void ConfigureServices(IServiceCollection services)
        {
            services.AddControllers();

    //add shardingdbcontext support life scope
                
       services.AddShardingDbContext<DefaultShardingDbContext>(
                   (conStr, builder) => builder.UseSqlServer(conStr)
                ).Begin(o =>
                {
                    o.CreateShardingTableOnStart = true;
                    o.EnsureCreatedWithOutShardingTable = true;
                })
                .AddShardingTransaction((connection, builder) =>
                    builder.UseSqlServer(connection))
                .AddDefaultDataSource("ds0","Data Source=localhost;Initial Catalog=ShardingCoreDBxx0;Integrated Security=True;")
                .AddShardingDataSource(sp =>
                {
                    return new Dictionary<string, string>()
                    {
                        {"ds1", "Data Source=localhost;Initial Catalog=ShardingCoreDBxx1;Integrated Security=True;"},
                        {"ds2", "Data Source=localhost;Initial Catalog=ShardingCoreDBxx2;Integrated Security=True;"},
                    };
                }).AddShardingDataSourceRoute(o =>
                {
                    o.AddShardingDatabaseRoute<SysUserModVirtualDataSourceRoute>();
                }).End();
```

`Startup.cs` ‰∏ãÁöÑ ` Configure(IApplicationBuilder app, IWebHostEnvironment env)` ‰Ω†‰πüÂèØ‰ª•Ëá™Ë°åÂ∞ÅË£Ö[app.UseShardingCore()](https://github.com/xuejmnet/sharding-core/blob/main/samples/Sample.SqlServer/DIExtension.cs)

```c#

            var shardingBootstrapper = app.ApplicationServices.GetRequiredService<IShardingBootstrapper>();
            shardingBootstrapper.Start();
```
Â¶Ç‰Ωï‰ΩøÁî®
```c#
    
        private readonly DefaultShardingDbContext _defaultShardingDbContext;

        public ctor(DefaultShardingDbContext defaultShardingDbContext)
        {
            _defaultShardingDbContext = defaultShardingDbContext;
        }

        public async Task Insert_1000()
        {
            if (!_defaultShardingDbContext.Set<SysUserMod>().Any())
                {
                    var ids = Enumerable.Range(1, 1000);
                    var userMods = new List<SysUserMod>();
                    foreach (var id in ids)
                    {
                        userMods.Add(new SysUserMod()
                        {
                            Id = id.ToString(),
                            Age = id,
                            Name = $"name_{id}",
                            AgeGroup = Math.Abs(id % 10)
                        });
                    }

                    _defaultShardingDbContext.AddRange(userMods);

                   await _defaultShardingDbContext.SaveChangesAsync();
                }
        }
        public async Task ToList_All()
        {
            
            var mods = await _defaultShardingDbContext.Set<SysUserMod>().ToListAsync();
            Assert.Equal(1000, mods.Count);

            var modOrders1 = await _defaultShardingDbContext.Set<SysUserMod>().OrderBy(o => o.Age).ToListAsync();
            int ascAge = 1;
            foreach (var sysUserMod in modOrders1)
            {
                Assert.Equal(ascAge, sysUserMod.Age);
                ascAge++;
            }

            var modOrders2 = await _defaultShardingDbContext.Set<SysUserMod>().OrderByDescending(o => o.Age).ToListAsync();
            int descAge = 1000;
            foreach (var sysUserMod in modOrders2)
            {
                Assert.Equal(descAge, sysUserMod.Age);
                descAge--;
            }
        }
```
Êõ¥Â§öÊìç‰ΩúÂèØ‰ª•ÂèÇËÄÉÂçïÂÖÉÊµãËØï

## Api

ÊñπÊ≥ï  | Method | [Unit Test](https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs) 
--- |--- |--- 
Ëé∑ÂèñÈõÜÂêà |ToListAsync |yes 
Á¨¨‰∏ÄÊù° |FirstOrDefaultAsync |yes 
ÊúÄÂ§ß |MaxAsync |yes 
ÊúÄÂ∞è |MinAsync |yes 
ÊòØÂê¶Â≠òÂú® |AnyAsync |yes 
Êï∞ÁõÆ |CountAsync |yes 
Êï∞ÁõÆ |LongCountAsync |yes 
Ê±ÇÂíå |SumAsync |yes 
Âπ≥Âùá |AverageAsync |yes 
ÂåÖÂê´ |ContainsAsync |yes 
ÂàÜÁªÑ |GroupByAsync |yes 

## ÈªòËÆ§Ë∑ØÁî±
ÂàÜÂ∫ìÊèê‰æõ‰∫ÜÈªòËÆ§ÁöÑË∑ØÁî±ÂàÜË°®ÂàôÈúÄË¶ÅËá™Â∑±ÂéªÂÆûÁé∞,ÂÖ∑‰ΩìÂÆûÁé∞ÂèØ‰ª•ÂèÇËÄÉÂàÜÂ∫ì

ÊäΩË±°abstract | Ë∑ØÁî±ËßÑÂàô | tail | Á¥¢Âºï
--- |--- |--- |--- 
AbstractSimpleShardingModKeyIntVirtualTableRoute |ÂèñÊ®° |0,1,2... | `=,contains`
AbstractSimpleShardingModKeyStringVirtualTableRoute |ÂèñÊ®° |0,1,2... | `=,contains`
AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute |ÊåâÊó∂Èó¥ |yyyyMMdd | `>,>=,<,<=,=,contains`
AbstractSimpleShardingDayKeyLongVirtualTableRoute |ÊåâÊó∂Èó¥Êà≥ |yyyyMMdd | `>,>=,<,<=,=,contains`
AbstractSimpleShardingWeekKeyDateTimeVirtualTableRoute |ÊåâÊó∂Èó¥ |yyyyMMdd_dd | `>,>=,<,<=,=,contains`
AbstractSimpleShardingWeekKeyLongVirtualTableRoute |ÊåâÊó∂Èó¥Êà≥ |yyyyMMdd_dd | `>,>=,<,<=,=,contains`
AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute |ÊåâÊó∂Èó¥ |yyyyMM | `>,>=,<,<=,=,contains`
AbstractSimpleShardingMonthKeyLongVirtualTableRoute |ÊåâÊó∂Èó¥Êà≥ |yyyyMM | `>,>=,<,<=,=,contains`
AbstractSimpleShardingYearKeyDateTimeVirtualTableRoute |ÊåâÊó∂Èó¥ |yyyy | `>,>=,<,<=,=,contains`
AbstractSimpleShardingYearKeyLongVirtualTableRoute |ÊåâÊó∂Èó¥Êà≥ |yyyy | `>,>=,<,<=,=,contains`

Ê≥®:`contains`Ë°®Á§∫‰∏∫`o=>ids.contains(o.shardingkey)`
Ê≥®:‰ΩøÁî®ÈªòËÆ§ÁöÑÊåâÊó∂Èó¥ÂàÜË°®ÁöÑË∑ØÁî±ËßÑÂàô‰ºöËÆ©‰Ω†ÈáçÂÜô‰∏Ä‰∏™GetBeginTimeÁöÑÊñπÊ≥ïËøô‰∏™ÊñπÊ≥ïÂøÖÈ°ª‰ΩøÁî®ÈùôÊÄÅÂÄºÂ¶Ç:new DateTime(2021,1,1)‰∏çÂèØ‰ª•Áî®Âä®ÊÄÅÂÄºÊØîÂ¶ÇDateTime.NowÂõ†‰∏∫ÊØèÊ¨°ÈáçÊñ∞ÂêØÂä®ÈÉΩ‰ºöË∞ÉÁî®ËØ•ÊñπÊ≥ïÂä®ÊÄÅÊÉÖÂÜµ‰∏ã‰ºöÂØºËá¥ÊØèÊ¨°ÈÉΩ‰∏ç‰∏ÄËá¥

# È´òÁ∫ß

## code-first
ÁõÆÂâç`sharding-core`Â∑≤ÁªèÊîØÊåÅcode firstÊîØÊåÅ‰ª£Á†ÅÁé∞Ë°åÔºåÂÖ∑‰ΩìÂÆûÁé∞ÂèØ‰ª•ÂèÇËÄÉ[Migrations](https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.Migrations/readme.md)

## Ëá™Âä®ËøΩË∏™
ÈªòËÆ§shardingcore‰∏çÊîØÊåÅËá™Âä®ËøΩË∏™,Âπ∂‰∏î‰πü‰∏çÂª∫ËÆÆ‰ΩøÁî®Ëá™Âä®ËøΩË∏™,Â¶ÇÊûú‰Ω†ÊúâÈúÄË¶Åshardingcore‰πüÈªòËÆ§Êèê‰æõ‰∫ÜËá™Âä®ËøΩË∏™ÂäüËÉΩ
Êúâ‰∏§ÁÇπÈúÄË¶ÅÊ≥®ÊÑè
ÁõÆÂâç‰ªÖÊîØÊåÅÂçï‰∏ªÈîÆÂØπË±°
1.shardingcore‰ªÖÊîØÊåÅdbcontextÁöÑmodelÁöÑÁ±ªÂûãÁöÑÊï¥‰∏™Êü•ËØ¢ÂåøÂêçÁ±ªÂûã‰∏çÊîØÊåÅËÅîÁ∫ßÊü•ËØ¢‰∏çÊîØÊåÅ
2.shardingcoreÁöÑÂçï‰∏™Êü•ËØ¢‰æùÁÑ∂Ëµ∞Êï∞ÊçÆÂ∫ì‰∏çËµ∞ÁºìÂ≠òÂ¶ÇÊûúÊü•ËØ¢Âá∫Êù•ÁöÑÁªìÊûúÁºìÂ≠òÈáåÈù¢ÊúâÂ∞±ËøîÂõûÁºìÂ≠òÈáåÈù¢ÁöÑËÄå‰∏çÊòØÊï∞ÊçÆÂ∫ìÁöÑ
3.tolistÁ≠âÊìç‰Ωú‰ºöÊü•ËØ¢Êï∞ÊçÆÂ∫ìËøîÂõûÁöÑÊó∂ÂÄôÂà§Êñ≠ÊòØÂê¶Â∑≤ÁªèËøΩË∏™Â¶ÇÊûúÂ∑≤ÁªèËøΩË∏™ÂàôËøîÂõûÁºìÂ≠òÈáåÂ∑≤ÁªèËøΩË∏™‰∫ÜÁöÑÂÄº
4.ÊîØÊåÅ `first`,`firstordefault`,`last`,`lastordefault`,`single`,`singleordefault`
Â¶Ç‰ΩïÂºÄÂêØ
```c#
services.AddShardingDbContext<DefaultShardingDbContext>(.......)
            .Begin(o => {
                    o.CreateShardingTableOnStart = true;
                    o.EnsureCreatedWithOutShardingTable = true;
                    //autotrack support asnotracking astracking QueryTrackingBehavior.TrackAll
                    o.AutoTrackEntity = true; 
                })
```

## ÊâãÂä®Ë∑ØÁî±
```c#
ctor inject IShardingRouteManager shardingRouteManager

    public class SysUserModVirtualTableRoute : AbstractSimpleShardingModKeyStringVirtualTableRoute<SysUserMod>
    {
        /// <summary>
        /// ÂºÄÂêØÊèêÁ§∫Ë∑ØÁî±
        /// </summary>
        protected override bool EnableHintRoute => true;

        public SysUserModVirtualTableRoute() : base(2,3)
        {
        }
    }


    

    using (_shardingRouteManager.CreateScope())
    {
        _shardingRouteManager.Current.TryCreateOrAddMustTail<SysUserMod>("00");

        var mod00s = await _defaultTableDbContext.Set<SysUserMod>().Skip(10).Take(11).ToListAsync();
    }
```

## Ëá™Âä®Âª∫Ë°®
[ÂèÇËÄÉ](https://github.com/xuejmnet/sharding-core/tree/main/samples/Samples.AutoByDate.SqlServer)

## ‰∫ãÂä°
1.ÈªòËÆ§savechangesÊîØÊåÅ‰∫ãÂä°
```c#

 await  _defaultShardingDbContext.SaveChangesAsync();
     
```
2.ÊâãÂä®ÂºÄÂêØ‰∫ãÂä° [ËØ∑ÂèÇËÄÉÂæÆËΩØ](https://docs.microsoft.com/zh-cn/ef/core/saving/transactions)
```c#
            using (var tran = _defaultTableDbContext.DataBase.BeginTransaction())
            {
                    ........
                _defaultTableDbContext.SaveChanges();
                tran.Commit();
            }
```


## ÊâπÈáèÊìç‰Ωú

ÊâπÈáèÊìç‰ΩúÂ∞ÜÂØπÂ∫îÁöÑdbcontextÂíåÊï∞ÊçÆËøõË°åÂàÜÁ¶ªÁî±Áî®Êà∑Ëá™Â∑±ÈÄâÊã©Á¨¨‰∏âÊñπÊ°ÜÊû∂ÊØîÂ¶Ç[`Z.EntityFramework.Plus.EFCore`](https://github.com/zzzprojects/EntityFramework-Plus) ËøõË°åÊâπÈáèÊìç‰ΩúÊàñËÄÖ [`EFCore.BulkExtensions`](https://github.com/borisdj/EFCore.BulkExtensions) ,ÊîØÊåÅ‰∏ÄÂàá‰∏âÊñπÊâπÈáèÊ°ÜÊû∂
```c#
var list = new List<SysUserMod>();
///ÈÄöËøáÈõÜÂêàËøîÂõûÂá∫ÂØπÂ∫îÁöÑk-vÂΩíÈõÜÈÄöËøá‰∫ãÂä°ÂºÄÂêØ
            var dbContexts = _defaultTableDbContext.BulkShardingEnumerable(list);

           
                    foreach (var dataSourceMap in dbContexts)
                    {
                        foreach (var tailMap in dataSourceMap.Value)
                        {
                            tailMap.Key.BulkInsert(tailMap.Value.ToList());
                            //tailMap.Key.BulkDelete(tailMap.Value.ToList());
                            //tailMap.Key.BulkUpdate(tailMap.Value.ToList());
                        }
                    }
                _defaultTableDbContext.SaveChanges();
          //or
            var dbContexts = _defaultTableDbContext.BulkShardingEnumerable(list);
            using (var tran = _defaultTableDbContext.Database.BeginTransaction())
            {
                    foreach (var dataSourceMap in dbContexts)
                    {
                        foreach (var tailMap in dataSourceMap.Value)
                        {
                            tailMap.Key.BulkInsert(tailMap.Value.ToList());
                            //tailMap.Key.BulkDelete(tailMap.Value.ToList());
                            //tailMap.Key.BulkUpdate(tailMap.Value.ToList());
                        }
                    }
                _defaultTableDbContext.SaveChanges();
                tran.Commit();
            }

```
## code-first

## ËØªÂÜôÂàÜÁ¶ª
ËØ•Ê°ÜÊû∂ÁõÆÂâçÂ∑≤ÁªèÊîØÊåÅ‰∏Ä‰∏ªÂ§ö‰ªéÁöÑËØªÂÜôÂàÜÁ¶ª`AddReadWriteSeparation`,ÊîØÊåÅËΩÆËØ¢ LoopÂíåÈöèÊú∫ Random‰∏§ÁßçËØªÂÜôÂàÜÁ¶ªÁ≠ñÁï•,ÂèàÂõ†‰∏∫ËØªÂÜôÂàÜÁ¶ªÂ§öÈìæÊé•ÁöÑÊó∂ÂÄô‰ºöÂØºËá¥Êï∞ÊçÆËØªÂÜô‰∏ç‰∏ÄËá¥,(Â¶ÇÂàÜÈ°µÂÖ∂ÂÆûÊòØ2Ê≠•Á¨¨‰∏ÄÊ≠•Ëé∑ÂèñcountÔºåÁ¨¨‰∫åÈÉ®Ëé∑Âèñlist)‰ºöÂØºËá¥Êï∞ÊçÆÈáèÂú®ÊúÄÂêéÂá†È°µÂá∫Áé∞Áº∫ÈáèÁöÑÈóÆÈ¢ò,
ÈíàÂØπËøô‰∏™ÈóÆÈ¢òÊ°ÜÊû∂ÁõÆÂâçÂÆûÁé∞‰∫ÜËá™ÂÆö‰πâËØªÈìæÊé•Ëé∑ÂèñÁ≠ñÁï•`ReadConnStringGetStrategyEnum.LatestEveryTime`Ë°®Á§∫‰∏∫ÊØèÊ¨°ÈÉΩÊòØÊñ∞ÁöÑ(Ëøô‰∏™ÊÉÖÂÜµ‰∏ã‰ºöÂá∫Áé∞‰∏äËø∞ÈóÆÈ¢ò),`ReadConnStringGetStrategyEnum.LatestFirstTime`Ë°®Á§∫‰ª•dbcontext‰Ωú‰∏∫Âçï‰ΩçËé∑Âèñ‰∏ÄÊ¨°(Âêådbcontext‰∏ç‰ºöÂá∫Áé∞ÈóÆÈ¢ò),
ÂèàÂõ†‰∏∫ÂêÑËäÇÁÇπËØªÂÜôÂàÜÁ¶ªÁΩëÁªúÁ≠â‰∏ÄÁ≥ªÂàóÈóÆÈ¢ò‰ºöÂØºËá¥ÂàöÂàöÂÜôÂÖ•ÁöÑÊï∞ÊçÆÊ≤°ÂäûÊ≥ïËé∑ÂèñÂà∞ÊâÄ‰ª•Á≥ªÁªüÈªòËÆ§Âú®dbcontext‰∏äÊ∑ªÂä†ÊòØÂê¶‰ΩøÁî®ËØªÂÜôÂàÜÁ¶ªÂ¶ÇÊûúfalseÈªòËÆ§ÈÄâÊã©ÂÜôÂ≠óÁ¨¶‰∏≤ÂéªËØªÂèñ`_defaultTableDbContext.ReadWriteSeparation=false`ÊàñËÄÖ‰ΩøÁî®‰∏§‰∏™Â∞ÅË£ÖÂ•ΩÁöÑÊñπÊ≥ï
```c#
 //ÂàáÊç¢Âà∞Âè™ËØªÊï∞ÊçÆÂ∫ìÔºåÂè™ËØªÊï∞ÊçÆÂ∫ìÂèàÂè™ÈÖçÁΩÆ‰∫ÜAÊï∞ÊçÆÊ∫êËØªÂèñBÊï∞ÊçÆÊ∫ê
            _virtualDbContext.ReadWriteSeparationReadOnly();
            _virtualDbContext.ReadWriteSeparationWriteOnly();
```

```c#
services.AddShardingDbContext<DefaultShardingDbContext>(
                    (conStr, builder) => builder.UseSqlServer(conStr).UseLoggerFactory(efLogger)
                ).Begin(o =>
                {
                    o.CreateShardingTableOnStart = true;
                    o.EnsureCreatedWithOutShardingTable = true;
                })
                .AddShardingTransaction((connection, builder) =>
                    builder.UseSqlServer(connection).UseLoggerFactory(efLogger))
                .AddDefaultDataSource("ds0",
                    "Data Source=localhost;Initial Catalog=ShardingCoreDB1;Integrated Security=True;")
                .AddShardingTableRoute(o =>
                {
                    o.AddShardingTableRoute<SysUserModVirtualTableRoute>();
                }).AddReadWriteSeparation(o =>
                {
                    return new Dictionary<string, ISet<string>>()
                    {
                        {
                            "ds0", new HashSet<string>(){
                            "Data Source=localhost;Initial Catalog=ShardingCoreDBReadOnly1;Integrated Security=True;",
                            "Data Source=localhost;Initial Catalog=ShardingCoreDBReadOnly2;Integrated Security=True;"}
                        }
                    };
                }, ReadStrategyEnum.Loop,defaultEnable:true).End();

            _virtualDbContext.ReadWriteSeparationReadOnly();
                //reslove read write delay data not found
                //dbcontext use write connection string 
            _virtualDbContext.ReadWriteSeparationWriteOnly();
```

## È´òÊÄßËÉΩÂàÜÈ°µ
sharding-coreÊú¨Ë∫´‰ΩøÁî®ÊµÅÂºèÂ§ÑÁêÜËé∑ÂèñÊï∞ÊçÆÂú®ÊôÆÈÄöÊÉÖÂÜµ‰∏ãÂíåÂçïË°®ÁöÑÂ∑ÆË∑ùÂü∫Êú¨Ê≤°Êúâ,‰ΩÜÊòØÂú®ÂàÜÈ°µË∑≥ËøáXÈ°µÂêé,ÊÄßËÉΩ‰ºöÈöèÁùÄXÁöÑÂ¢ûÂ§ßËÄåÂáèÂ∞èO(n)
ÁõÆÂâçËØ•Ê°ÜÊû∂Â∑≤ÁªèÂÆûÁé∞‰∫Ü‰∏ÄÂ•óÈ´òÊÄßËÉΩÂàÜÈ°µÂèØ‰ª•Ê†πÊçÆÁî®Êà∑ÈÖçÁΩÆ,ÂÆûÁé∞ÂàÜÈ°µÂäüËÉΩ„ÄÇ

ÊîØÊåÅÁâàÊú¨`x.2.0.16+`

1.Â¶Ç‰ΩïÂºÄÂêØÂàÜÈ°µÈÖçÁΩÆ ÊØîÂ¶ÇÊàë‰ª¨ÈíàÂØπÁî®Êà∑ÊúàÊñ∞Ë°®ËøõË°åÂàÜÈ°µÈÖçÁΩÆ,ÂÖàÂÆûÁé∞`IPaginationConfiguration<>`Êé•Âè£,ËØ•Êé•Âè£ÊòØÂàÜÈ°µÈÖçÁΩÆÊé•Âè£
```c#

    public class SysUserSalaryPaginationConfiguration:IPaginationConfiguration<SysUserSalary>
    {
        public void Configure(PaginationBuilder<SysUserSalary> builder)
        {
            builder.PaginationSequence(o => o.Id)
                .UseRouteCompare(Comparer<string>.Default)
                .UseQueryMatch(PaginationMatchEnum.Owner | PaginationMatchEnum.Named | PaginationMatchEnum.PrimaryMatch);
            builder.PaginationSequence(o => o.DateOfMonth)
                .UseQueryMatch(PaginationMatchEnum.Owner | PaginationMatchEnum.Named | PaginationMatchEnum.PrimaryMatch).UseAppendIfOrderNone(10);
            builder.PaginationSequence(o => o.Salary)
                .UseQueryMatch(PaginationMatchEnum.Owner | PaginationMatchEnum.Named | PaginationMatchEnum.PrimaryMatch).UseAppendIfOrderNone();
            builder.ConfigReverseShardingPage(0.5d,10000L);
        }
    }
```
2.Ê∑ªÂä†ÈÖçÁΩÆ
Âú®ÂØπÂ∫îÁöÑÁî®Êà∑Ë∑ØÁî±‰∏≠Ê∑ªÂä†ÈÖçÁΩÆ [XXXXXXVirtualTableRoute]
```c#
        public override IPaginationConfiguration<SysUserSalary> CreatePaginationConfiguration()
        {
            return new SysUserSalaryPaginationConfiguration();
        }
```
3.ConfigureÂÜÖÈÉ®‰∏∫‰ªÄ‰πàÊÑèÊÄù?
1) builder.PaginationSequence(o => o.Id) ÈÖçÁΩÆÂΩìÂàÜÈ°µorderby Â≠óÊÆµ‰∏∫IdÊó∂ÈÇ£‰πàÂàÜË°®ÊâÄÂØπÂ∫îÁöÑË°®ÁªìÊûÑ‰∏∫È°∫Â∫è,È°∫Â∫èÁöÑËßÑÂàôÈÄöËøá`UseRouteCompare`Êù•ËÆæÁΩÆ,ÂÖ∂‰∏≠string‰∏∫Ë°®tail Êàñ data source name,
ÂÖ∑‰Ωì‰ªÄ‰πàÊÑèÊÄùÂ∞±ÊòØËØ¥Â¶ÇÊûúÊú¨Ê¨°ÂàÜÈ°µËÆæËÆ°3Âº†Ë°®ÂàÜÂà´ÊòØtable1,table2,table3,Â¶ÇÊûúÊàëÊ≤°ÈÖçÁΩÆidÁöÑÊÉÖÂÜµ‰∏ãÈÇ£‰πàÈúÄË¶ÅÊü•ËØ¢3Âº†Ë°®ÁÑ∂ÂêéÂàÜÂà´ËøõË°åÊµÅÂºèËÅöÂêà,Â¶ÇÊûúÊàëÈÖçÁΩÆ‰∫ÜidÁöÑÊÉÖÂÜµ‰∏ã,Â¶ÇÊûúÊú¨Ê¨°sqlÊü•ËØ¢Â∏¶‰∏ä‰∫Üid‰Ωú‰∏∫order byÂ≠óÊÆµ
   ÈÇ£‰πàÂ∞±‰∏çÈúÄË¶ÅÂàÜÂà´Êü•ËØ¢3Âº†Ë°®,ÂèØ‰ª•Áõ¥Êé•Êü•ËØ¢table1Â¶ÇÊûútable1ÁöÑcountÂ§ß‰∫é‰Ω†Ë¶ÅË∑≥ËøáÁöÑÈ°µÊï∞,ÂÅáËÆæÂàÜÈ°µÊü•ËØ¢ÂÖàÊü•ËØ¢Â§öÂ∞ëÊù°,table1:100Êù°,table2:200Êù°,table3:300Êù°
   Â¶ÇÊûú‰Ω†Ë¶ÅË∑≥Ëøá90Êù°Ëé∑Âèñ10Êù°ÂéüÂÖàÁöÑÊó∂Èó¥Â∞±ÊòØO(100)Áé∞Âú®ÁöÑÊó∂Èó¥Â∞±ÊòØO(10)Âõ†‰∏∫table1Ë∑≥Ëøá‰∫Ü90Êù°ËøòÂâ©‰Ωô10Êù°;
2) `UseQueryMatch`ÊòØ‰ªÄ‰πàÊÑèÊÄù,Ëøô‰∏™Â∞±ÊòØË°®Á§∫‰Ω†Ë¶ÅÂåπÈÖçÁöÑËßÑÂàô,ÊòØÂøÖÈ°ªÊòØÂΩìÂâçËøô‰∏™Á±ª‰∏ãÁöÑÂ±ûÊÄßËøòÊòØËØ¥Âè™ÈúÄË¶ÅÊéíÂ∫èÂêçÁß∞‰∏ÄÊ†∑Âç≥ÂèØ,Âõ†‰∏∫ÊúâÂèØËÉΩselect new{}ÂåøÂêçÂØπË±°Á±ªÂûãÂ∞±‰ºö‰∏ç‰∏ÄÊ†∑,`PrimaryMatch`Ë°®Á§∫ÊòØÂê¶Âè™ÈúÄË¶ÅÁ¨¨‰∏Ä‰∏™‰∏ªË¶ÅÁöÑ
orderbyÂåπÈÖç‰∏äÂ∞±Ë°å‰∫Ü,`UseAppendIfOrderNone`Ë°®Á§∫ÊòØÂê¶ÈúÄË¶ÅÂºÄÂêØÂú®Ê≤°ÊúâÂØπÂ∫îorderÊü•ËØ¢Êù°‰ª∂ÁöÑÂâçÊèê‰∏ãÊ∑ªÂä†Êú¨Â±ûÊÄßÊéíÂ∫è,ËøôÊ†∑ÂèØ‰ª•‰øùËØÅÈ°∫Â∫èÊéíÂ∫èÊÄßËÉΩÊúÄ‰ºò
3) `builder.ConfigReverseShardingPage` Ë°®Á§∫ÊòØÂê¶ÈúÄË¶ÅÂêØÁî®ÂèçÂêëÊéíÂ∫è,Âõ†‰∏∫Ê≠£ÂêëÊéíÂ∫èÂú®skipËøáÂ§öÂêé‰ºöÂØºËá¥ÈúÄË¶ÅË∑≥ËøáÁöÑÊï∞ÊçÆËøáÂ§ö,Â∞§ÂÖ∂ÊòØÊúÄÂêéÂá†È°µ,Â¶ÇÊûúÂºÄÂêØÂÖ∂ÂÆûÊúÄÂêéÂá†È°µÂ∞±ÊòØÂâçÂá†È°µÁöÑÂèçÂêëÊéíÂ∫è,ÂÖ∂‰∏≠Á¨¨‰∏Ä‰∏™ÂèÇÊï∞Ë°®Á§∫Ë∑≥ËøáÁöÑÂõ†Â≠ê,Â∞±ÊòØËØ¥
skipÂøÖÈ°ªÂ§ß‰∫éÂàÜÈ°µÊÄªtotal*ËØ•Âõ†Â≠ê(0-1ÁöÑdouble),Á¨¨‰∫å‰∏™ÂèÇÊï∞Ë°®Á§∫ÊúÄÂ∞ëÈúÄË¶ÅtotalÂ§öÂ∞ëÊù°ÂøÖÈ°ªÂêåÊó∂Êª°Ë∂≥‰∏§‰∏™Êù°‰ª∂Êâç‰ºöÂºÄÂêØ(ÂøÖÈ°ªÂ§ß‰∫é500),Âπ∂‰∏îÂèçÂêëÊéíÂ∫è‰ºòÂÖàÁ∫ß‰Ωé‰∫éÈ°∫Â∫èÊéíÂ∫è,
4.Â¶Ç‰Ωï‰ΩøÁî®
 ```c#
var shardingPageResultAsync = await _defaultTableDbContext.Set<SysUserMod>().OrderBy(o=>o.Age).ToShardingPageAsync(pageIndex, pageSize);
```
### Ê≥®ÊÑè:Â¶ÇÊûú‰Ω†ÊòØÊåâÊó∂Èó¥ÊéíÂ∫èÊó†ËÆ∫‰ΩïÁßçÊéíÂ∫èÂª∫ËÆÆÂºÄÂêØÂπ∂‰∏îÂä†‰∏äÊó∂Èó¥È°∫Â∫èÊéíÂ∫è,Â¶ÇÊûú‰Ω†ÊòØÂèñÊ®°ÊàñËÄÖËá™ÂÆö‰πâÂàÜË°®,Âª∫ËÆÆÂ∞ÜId‰Ωú‰∏∫È°∫Â∫èÊéíÂ∫è,Â¶ÇÊûúÊ≤°ÊúâÁâπÊÆäÊÉÖÂÜµËØ∑‰ΩøÁî®idÊéíÂ∫èÂπ∂‰∏îÂä†‰∏äÂèçÂêëÊéíÂ∫è‰Ωú‰∏∫ÊÄßËÉΩ‰ºòÂåñ,Â¶ÇÊûúentityÂêåÊó∂ÊîØÊåÅÂàÜË°®ÂàÜÂ∫ìÂπ∂‰∏î‰∏§‰∏™Ë∑ØÁî±ÈÉΩÊîØÊåÅÂêå‰∏Ä‰∏™Â±ûÊÄßÁöÑÈ°∫Â∫èÊéíÂ∫è‰ºòÂÖàÁ∫ß‰∏∫ÂÖàÂàÜÂ∫ìÂêéÂàÜË°®

## Ë°®ËææÂºèÁºìÂ≠ò
ÂèØ‰ª•ÈÄöËøáË∑ØÁî±ÂºÄÂêØË°®ËææÂºèÁºìÂ≠òÈíàÂØπÂçï‰∏™tailÁöÑË°®ËææÂºèËøõË°åÁºìÂ≠òÊîØÊåÅ=,>,>=,<,<=,equal
```c#

   public  class OrderCreateTimeVirtualTableRoute:AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<Order>
    {
        //ÂºÄÂêØË°®ËææÂºèÁºìÂ≠ò
        public override bool EnableRouteParseCompileCache => true;
    }
```
ÈíàÂØπË°®ËææÂºèÁºìÂ≠òÂèØ‰ª•Ëá™Ë°åÈáçÂÜôÁà∂Á±ªÊñπÊ≥ïÊù•Ëá™Ë°åÂÆûÁé∞Ôºå‰πüÂèØ‰ª•‰ªÖÂÆûÁé∞Â§ötailË°®ËææÂºè`AbstractShardingRouteParseCompileCacheVirtualTableRoute`,`AbstractShardingRouteParseCompileCacheVirtualDataSourceRoute`
```c#
        public virtual Func<string, bool> CachingCompile(Expression<Func<string, bool>> parseWhere)
        {
            if (EnableRouteParseCompileCache)
            {
                var doCachingCompile = DoCachingCompile(parseWhere);
                if (doCachingCompile != null)
                    return doCachingCompile;
                doCachingCompile = CustomerCachingCompile(parseWhere);
                if (doCachingCompile != null)
                    return doCachingCompile;
            }
            return parseWhere.Compile();
        }
        /// <summary>
        /// Á≥ªÁªüÈªòËÆ§Ê∞∏‰πÖÂçïË°®ËææÂºèÁºìÂ≠ò
        /// </summary>
        /// <param name="parseWhere"></param>
        /// <returns>ËøîÂõûnull‰ºöËµ∞<see cref="CustomerCachingCompile"/>Ëøô‰∏™ÊñπÊ≥ïÂ¶ÇÊûúËøòÊòØnullÂ∞±‰ºöË∞ÉÁî®<see cref="Compile"/>ÊñπÊ≥ï</returns>
        protected virtual Func<string, bool> DoCachingCompile(Expression<Func<string, bool>> parseWhere)
        {
            var shouldCache = ShouldCache(parseWhere);
            if(shouldCache)
                return _routeCompileCaches.GetOrAdd(parseWhere, key => parseWhere.Compile());
            return null;
        }
        protected virtual Func<string, bool> CustomerCachingCompile(Expression<Func<string, bool>> parseWhere)
        {
            return null;
        }
```

ÂºÄÂêØË°®ËææÂºèÁºìÂ≠òÂèØ‰ª•Â∞ÜË∑ØÁî±Ê®°ÂùóÁöÑÁºñËØëÁî±ÂéüÂÖàÁöÑ0.14msÂçáÁ∫ßÂà∞0.013msÊèêÁ§∫Á∫¶0.13msÂ∞ÜËøë10ÂÄçÊÄßËÉΩ

# Ê≥®ÊÑè‰∫ãÈ°π
‰ΩøÁî®ËØ•Ê°ÜÊû∂ÈúÄË¶ÅÊ≥®ÊÑè‰∏§ÁÇπÂ¶ÇÊûú‰Ω†ÁöÑshardingdbcontextÈáçÂÜô‰∫Ü‰ª•‰∏ãÊúçÂä°ÂèØËÉΩÊó†Ê≥ï‰ΩøÁî® Â¶ÇÊûúËøòÊÉ≥‰ΩøÁî®ÈúÄË¶ÅËá™Â∑±ÈáçÂÜôÊâ©Â±ï[ËØ∑ÂèÇËÄÉ](https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/DIExtension.cs)
1.shardingdbcontext
```c#
   return optionsBuilder.UseShardingWrapMark()
                .ReplaceService<IDbSetSource, ShardingDbSetSource>()
                .ReplaceService<IQueryCompiler, ShardingQueryCompiler>()
                .ReplaceService<IDbContextTransactionManager, ShardingRelationalTransactionManager<TShardingDbContext>>()
                .ReplaceService<IRelationalTransactionFactory, ShardingRelationalTransactionFactory<TShardingDbContext>>();
```
2.defaultdbcontext
```c#
return optionsBuilder.ReplaceService<IModelCacheKeyFactory, ShardingModelCacheKeyFactory>()
                .ReplaceService<IModelCustomizer, ShardingModelCustomizer<TShardingDbContext>>();

```
,ÁõÆÂâçÊ°ÜÊû∂ÈááÁî®AppDomain.CurrentDomain.GetAssemblies();
ÂèØËÉΩ‰ºöÂØºËá¥Á®ãÂ∫èÈõÜÊú™Ë¢´Âä†ËΩΩÊâÄ‰ª•Â∞ΩÂèØËÉΩÂú®apiÂ±ÇÂä†ËΩΩÊâÄÈúÄË¶ÅÁöÑdll
‰ΩøÁî®Êó∂ÈúÄË¶ÅÊ≥®ÊÑè
- ÂàÜË°®ÂÆû‰ΩìÂØπË±°ÊòØÂê¶ÁªßÊâø`IShardingTable`
- ÂàÜË°®ÂÆû‰ΩìÂØπË±°ÊòØÂê¶Êúâ`ShardingKey`
- ÂàÜÂ∫ìÂÆû‰ΩìÂØπË±°ÊòØÂê¶ÁªßÊâø`IShardingDataSource`
- ÂàÜÂ∫ìÂÆû‰ΩìÂØπË±°ÊòØÂê¶Êúâ`ShardingDataSourceKey`
- ÂÆû‰ΩìÂØπË±°ÊòØÂê¶Â∑≤ÁªèÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ËôöÊãüË∑ØÁî±
- startupÊòØÂê¶Â∑≤ÁªèÊ∑ªÂä†ËôöÊãüË∑ØÁî±
- startupÊòØÂê¶Â∑≤ÁªèÊ∑ªÂä†bootstrapper.start()

```c#
//ÊîØÊåÅÊúÄÁªà‰øÆÊîπ
            var sresult =  _defaultTableDbContext.Set<SysUserMod>().ToList();

            var sysUserMod98 = result.FirstOrDefault(o => o.Id == "98");
            sysUserMod98.Name = "name_update"+new Random().Next(1,99)+"_98";
            await _defaultTableDbContext.SaveChangesAsync();
--log info
  Executed DbCommand (1ms) [Parameters=[@p1='?' (Size = 128), @p0='?' (Size = 128)], CommandType='Text', CommandTimeout='30']
      SET NOCOUNT ON;
      UPDATE [SysUserMod_02] SET [Name] = @p0
      WHERE [Id] = @p1;
      SELECT @@ROWCOUNT;
```


# ËÆ°Âàí
- [Êèê‰æõÂÆòÁΩëÂ¶ÇÊûúËØ•È°πÁõÆÊØîËæÉÊàêÂäüÁöÑËØù]
- [ÂºÄÂèëÊõ¥ÂÆåÂñÑÁöÑÊñáÊ°£]
- [ÈáçÊûÑÊàêÊîØÊåÅ.netÂÖ∂‰ªñorm]

# ÊúÄÂêé
ËØ•Ê°ÜÊû∂ÂÄüÈâ¥‰∫ÜÂ§ßÈÉ®ÂàÜÂàÜË°®ÁªÑ‰ª∂ÁöÑÊÄùË∑Ø,ÁõÆÂâçÊèê‰æõÁöÑÊé•Âè£ÈÉΩÂ∑≤ÁªèÂÆûÁé∞,Âπ∂‰∏îÊîØÊåÅË∑®Ë°®Êü•ËØ¢,Âü∫‰∫éÂàÜÈ°µÊü•ËØ¢ËØ•Ê°ÜÊû∂‰πü‰ΩøÁî®‰∫ÜÊµÅÂºèÊü•ËØ¢‰øùËØÅ‰∏ç‰ºöÂÜçskipÂ§ßÊï∞ÊçÆÁöÑÊó∂ÂÄôÂÜÖÂ≠ò‰ºöÁàÜÁÇ∏,ÁõÆÂâçËøô‰∏™Â∫ìÂè™ÊòØ‰∏Ä‰∏™ÂàöÂàöÊàêÂûãÁöÑÂ∫ìËøòÊúâÂæàÂ§ö‰∏çÂÆåÂñÑÁöÑÂú∞ÊñπÂ∏åÊúõÂ§ßÂÆ∂Â§öÂ§öÂåÖÊ∂µ,Â¶ÇÊûúÂñúÊ¨¢ÁöÑËØù‰πüÂ∏åÊúõÂ§ßÂÆ∂Áªô‰∏™star.
ËØ•ÊñáÊ°£ÊòØÊàëÊôö‰∏äËµ∂Â∑•Ëµ∂Âá∫Êù•ÁöÑ‰πüÊÉ≥Ë∂ÅÁÉ≠ÊâìÈìÅÂ∏åÊúõÊõ¥Â§öÁöÑ‰∫∫ÂÖ≥Ê≥®,‰πüÂ∏åÊúõÊõ¥Â§öÁöÑ‰∫∫ÂèØ‰ª•‰∫§ÊµÅ„ÄÇ

Âá≠ÂÄüÂêÑÂ§ßÂºÄÊ∫êÁîüÊÄÅÂúàÊèê‰æõÁöÑ‰ºòÁßÄ‰ª£Á†ÅÂíåÊÄùË∑ØÊâçÊúâÁöÑËøô‰∏™Ê°ÜÊû∂,Â∏åÊúõÂèØ‰ª•‰∏∫.NetÁîüÊÄÅÊèê‰æõ‰∏Ä‰ªΩÂæÆËñÑ‰πãÂäõ,ËØ•Ê°ÜÊû∂Êú¨‰∫∫‰ºö‰∏ÄÁõ¥ÈïøÊúüÁª¥Êä§,ÊúâÂ§ßÁ•ûÊäÄÊúØÊîØÊåÅÂèØ‰ª•ËÅîÁ≥ª‰∏ãÊñπÊñπÂºèÊ¨¢Ëøéstar :)

# ÊçêËµ†
<img src="./imgs/zfb.jpg" title="JetBrains" width=200 />
<img src="./imgs/wx.jpg" title="JetBrains" width=222 />
[ÂçöÂÆ¢](https://www.cnblogs.com/xuejiaming)

QQÁæ§:771630778

‰∏™‰∫∫QQ:326308290(Ê¨¢ËøéÊäÄÊúØÊîØÊåÅÊèê‰æõÊÇ®ÂÆùË¥µÁöÑÊÑèËßÅ)

‰∏™‰∫∫ÈÇÆÁÆ±:326308290@qq.com